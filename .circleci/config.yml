version: 2.1
orbs:
  orb-tools: circleci/orb-tools@8.27.6
  probely: probely/security-scan@1.1.3

description: |
  Start the scan on a target (website) using Probely.
parameters:
  api_key:
    default: 'eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ0ZW5hbnQiOiJwcm9iZWx5IiwidXNlcm5hbWUiOiIyNkZZNFlMWXFUNUwiLCJqdGkiOiJGdUxwMVFwNFpmbmgifQ.RHzdpz796MXjeRs30yM0ykdFgQzQInlVTAsCyx8DhMQ'
    description: >
      The Probely API key to use, defined in the PROBELY_API_KEY environment
      variable.
    type: string
  api_url:
    default: 'https://api.probely.com'
    description: The URL of Probely's API
    type: string
  target_id:
    default: 'http://owasp-juice.shop'
    description: The id of the target (website) to scan.
    type: string
steps:
  - run:
      command: |
        # Check if API key is set
        if [ -z "${<< parameters.api_key >>}" ]; then
          echo "NO PROBELY API KEY SET"
          echo "Please set your API key in the << parameters.api_key >> variable"
          exit 1
        fi
        # Check if target id is set
        if [ -z "<< parameters.target_id >>" ]; then
          echo "NO PROBELY TARGET ID SET"
          echo "Please set the target id as a parameter for this orb."
          exit 1
        fi
        curl -X POST \
            -H "Authorization: JWT ${<< parameters.api_key >>}" \
            << parameters.api_url >>/targets/<< parameters.target_id >>/scan_now/
        exit $?
      name: Probely - Starting Security Scan

workflows:
  scan-workflow:
    jobs:
      - orb-tools/lint
      - probely/scan:
          target_id: ${PROBELY_TARGET_ID}
